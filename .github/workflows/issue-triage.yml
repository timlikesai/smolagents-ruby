name: Issue Triage

on:
  issues:
    types: [opened, reopened]

jobs:
  triage:
    name: Auto-label new issues
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Add needs-triage label
        uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);

            // Skip if already has triage-related labels
            if (labels.some(l => ['needs-triage', 'ready', 'P0-critical', 'P1-high', 'P2-medium', 'P3-low'].includes(l))) {
              console.log('Issue already has triage labels, skipping');
              return;
            }

            // Add needs-triage label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['needs-triage']
            });

            console.log(`Added needs-triage label to issue #${issue.number}`);

      - name: Detect issue type from template
        uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body || '';
            const labels = issue.labels.map(l => l.name);

            const labelsToAdd = [];

            // Detect from title prefix (from issue templates)
            if (title.startsWith('bug:')) {
              if (!labels.includes('bug')) labelsToAdd.push('bug');
            } else if (title.startsWith('enh:')) {
              if (!labels.includes('enhancement')) labelsToAdd.push('enhancement');
            } else if (title.startsWith('doc:')) {
              if (!labels.includes('documentation')) labelsToAdd.push('documentation');
            }

            // Detect area from body content
            if (body.includes('lib/smolagents/tools') || body.includes('Tool')) {
              labelsToAdd.push('area-tools');
            } else if (body.includes('lib/smolagents/models') || body.includes('Model')) {
              labelsToAdd.push('area-models');
            } else if (body.includes('lib/smolagents/builders') || body.includes('Builder') || body.includes('DSL')) {
              labelsToAdd.push('area-builders');
            }

            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labelsToAdd
              });
              console.log(`Added labels: ${labelsToAdd.join(', ')}`);
            }
